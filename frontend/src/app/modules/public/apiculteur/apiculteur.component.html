
<p-toast></p-toast>


<div id="wrapper_full" class="content_all_warpper">
  <!----page-header----->

  <!----preloader----->

  <!----preloader end----->
  <!----header----->
  <app-header></app-header>
  <!----header----->

  <div id="content" class="site-content " style="min-height: 500px">

    <div class="container">

      <div class="mt-4 d-flex" style="justify-content: space-between;">

        <button class="btn btn-primary" (click)="addRuche()"> Ajouter ruche</button>

        <div style="float: right;">
          <p-selectButton [options]="stateOptions" (ngModelChange)="changeDisplay()"  [(ngModel)]="displayType" optionLabel="label" optionValue="value" />
        
        </div>

      </div>


      <div class="row mt-2 mb-4">

        <div *ngIf="displayType=='table'">
          <p-table #dt [rows]="10" [loading]="loadingRuche" [rowHover]="true" [paginator]="true" [value]="rucheList" sortMode="multiple"
                   styleClass="p-datatable-sm p-datatable-striped"
                   responsiveLayout="scroll"
                   [lazy]="true"
                   [totalRecords]="totalRecords"
                   (onLazyLoad)="loadItems($event)"
                   [resizableColumns]="true"
                   [responsive]="true"
                   currentPageReportTemplate="Affiche {first} à {last} sur {totalRecords} entrées"
                   [showCurrentPageReport]="true"
                   [globalFilterFields]="['libelle']" >


            <ng-template pTemplate="caption">
              <div class="d-flex p-ai-center justify-content-between">
                <h5 class="p-m-0">Liste des ruches</h5>
                <span class="p-input-icon-left">
                  <i class="pi pi-search"></i>
                  <input pInputText [(ngModel)]="search" (input)="dt.filterGlobal(search, 'contains')" type="text" class="form-control" style="padding-left: 30px"
                         placeholder="Rechercher une ruche..." />
                  </span>
              </div>
            </ng-template>

            <ng-template pTemplate="header">
              <tr>
                <th>Nom de la ruche</th>
                <th>Nombre d'intervention</th>
                <th>Recolte</th>
                <th>Actions</th>
              </tr>
            </ng-template>


            <ng-template pTemplate="body" let-dataItem>

              <tr>
                <td>{{dataItem.libelle}}</td>
                <td>{{dataItem?.interventions.length}}</td>
                <td>{{dataItem?.recoltes.length}} </td>

                <td>
                  <button  pButton pRipple icon="pi pi-eye" (click)="openInterventionDialog(dataItem)" class="p-button p-button-info" pTooltip="consulter" tooltipPosition="top"
                  ></button>

                  <button pButton pRipple icon="pi pi-pencil" class="p-button p-button-primary mr-2" pTooltip="Modifier" tooltipPosition="top"
                          (click)="editRuche(dataItem)"></button>
                  <button  pButton pRipple icon="pi pi-trash" class="p-button p-button-danger" pTooltip="Supprimer" tooltipPosition="top"
                          ></button>
                </td>

              </tr>
            </ng-template>


          </p-table>

        </div>

        <div class=" mt-4" *ngIf="displayType=='map'">
          
          <div class="map-container" leaflet
               [leafletOptions]="options"
               (leafletMapReady)="onMapReady($event)"
               (leafletClick)="mapClicked($event)">
          </div>
        </div>
      </div>


    </div>

  </div>

</div>

<app-footer></app-footer>
<!-- Modal of this page-->


<p-dialog  [header]="isUpdating?'Modification d\'une ruche':'Création d\'une ruche'" [baseZIndex]="999999990"  [closable]="true" [modal]="true"    [(visible)]="ruchedialog" [style]="{ width: '35rem' }">

  <form [formGroup]="rucheForm">

    <div class="form-group">
      <label for="nom" class="col-form-label">Nom de la ruche:</label>
      <input type="text" class="form-control" formControlName="nom" [(ngModel)]="this.ruche.libelle" name="nom" id="nom" required placeholder="Nom de la ruche">
    </div>

    <div class="form-group">
      <label  class="col-form-label">Position:</label>
      <a class="d-flex float-end choose-map" href="javascript:void(0)" (click)="openPositionDialog()"> choisir sur la carte </a>
      <div class="row">
        <div class="col-6 ps-0">
          <input type="text" class="form-control" formControlName="longitude" [(ngModel)]="this.ruche.longitude" name="longitude" id="position" required placeholder="longitude">
        </div>
        <div class="col-6 pe-0">
          <input type="text" class="form-control" formControlName="latitude" [(ngModel)]="this.ruche.latitude" name="latitude" id="position" required placeholder="latitude">
        </div>

      </div>
   
    </div>

    <div class="d-flex mt-4 justify-content-center align-items-center ">

      <button type="reset" [disabled]="senddingRequest || isUpdating" class="btn btn-light  btn_effacer me-2" (click)="fermerRuche()">Fermer</button>

      <button (click)="saveRuche()" type="button" [disabled]="rucheForm.invalid || senddingRequest" class="btn d-flex justify-content-center align-items-center btn-primary">
        <span *ngIf="!senddingRequest">Enregister</span>
        <div *ngIf="senddingRequest" class="spinner-border text-sucess" role="status">
          <span class="sr-only"></span>
        </div>

      </button>
    </div>
  </form>

</p-dialog>


<p-dialog [baseZIndex]="999999991" [header]="'Choisir une position sur la carte'" (onShow)="onDialogShow()" [closable]="true" [modal]="true"    [(visible)]="positionDialog" [style]="{ width: '70%', height:'80%'}">

  <div *ngIf="positionDialog" class="dialog-map-container" leaflet
    [leafletOptions]="optionsDialog"
    (leafletMapReady)="dialogOnMapReady($event)"
    (leafletClick)="dialogMapClicked($event)">
  </div>

  <div class="d-flex mt-4 justify-content-center align-items-center ">
    <button type="button" class="btn btn-light  btn_effacer me-2" (click)="positionDialog=false">Fermer</button>
    <button (click)="validerPosition()" type="button" [disabled]="position.lat==null || position.lon==null" class="btn d-flex justify-content-center align-items-center btn-primary">
      Valider cette position
    </button>
  </div>

</p-dialog>


<p-dialog [baseZIndex]="999999990" [header]="'Interventions de la ruche '+this.ruche.libelle"  [closable]="true" [modal]="true"    [(visible)]="interventionDialog" [style]="{ width: '70%', height:'100%'}">

 
 
  <ng-template pTemplate="body">

    <div class="container w-75" >
      <div class="mt-4 text-center">
        <p-table #dt [rows]="10" [loading]="loadingIntervention" [rowHover]="true" [paginator]="true" [value]="interventionList"
        styleClass="p-datatable-sm p-datatable-striped"
        responsiveLayout="scroll"
        [lazy]="true"
        [totalRecords]="totalInterventionRecords"
        (onLazyLoad)="loadItemIntervention($event)"
        [resizableColumns]="true"
        [responsive]="true"
        currentPageReportTemplate="Affiche {first} à {last} sur {totalRecords} entrées"
        [showCurrentPageReport]="true" >
    
          <ng-template pTemplate="caption">
          <div class="d-flex p-ai-center justify-content-between">
          <h5 class="p-m-0">Liste des interventions</h5>
    
          </div>
          </ng-template>
    
          <ng-template pTemplate="header">
          <tr>
          <th>Intervention</th>
          <th>Date</th>
          </tr>
          </ng-template>
    
    
          <ng-template pTemplate="body" let-dataItem>
    
          <tr>
            <td>{{dataItem.libelle}}</td>
            <td>{{dataItem.date}}</td>
          </tr>
          </ng-template>
    
    
        </p-table>
      </div>
    </div>

  </ng-template>


  <ng-template pTemplate="footer">
    <div class="d-flex mt-4 ">
      <button  type="button"  class="btn btn-primary">
        Ajouter intervention
      </button>
    </div>
  </ng-template>


</p-dialog>

<!-- Modal add intervention-->


<p-dialog  [header]="'Création d\'une intervention'" [baseZIndex]="999999992"  [closable]="true" [modal]="true"    [(visible)]="addInterventionDialog" [style]="{ width: '35rem' }">

  <form [formGroup]="interventionForm">

    <div class="form-group">
      <label for="libelle" class="col-form-label">Libellé de l'intervention:</label>
      <input type="text" class="form-control" formControlName="libelle" [(ngModel)]="this.intervention.libelle" name="libelle" id="libelle" required placeholder="Intervention">
    </div>

    <div class="form-group">
      <label  class="col-form-label">Date:</label>
      
   
    </div>

    <div class="d-flex mt-4 justify-content-center align-items-center ">

      <button type="reset" [disabled]="senddingRequest" class="btn btn-light  btn_effacer me-2" (click)="this.addInterventionDialog=false">Fermer</button>

      <button  type="button" [disabled]="interventionForm.invalid || senddingRequest" class="btn d-flex justify-content-center align-items-center btn-primary">
        <span *ngIf="!senddingRequest">Enregister</span>
        <div *ngIf="senddingRequest" class="spinner-border text-sucess" role="status">
          <span class="sr-only"></span>
        </div>


      </button>
    </div>
  </form>

</p-dialog>